## ACC-020: Variance Analysis

**Route:** /accounting/variance-analysis
**Component:** src/pages/accounting/VarianceAnalysisPage.tsx
**Guard:** accounting.invoices.read (via ROUTE_PERMISSION_MAP['accounting'])

### Roles
- Full access (bypass): super_admin, owner, operations_manager
- Navigation-level: No entry in NAVIGATION_PERMISSIONS
- Route guard resolves to: DENIED for all non-FULL_ACCESS_ROLES

### Database
- Primary: `budgets` joined with `budget_line_items` joined with `chart_of_accounts` joined with `departments` (for budget data)
- Primary: `account_transactions` joined with `journal_entries` (for actuals, queried per account per month)
- Secondary: `departments` (for filter dropdown, filtered by business_id, is_active=true)
- Filters: business_id, budget_year, status='approved' on budgets; entry_date range and status='posted' on journal_entries

### Behavior
1. Page wraps `VarianceAnalysisDashboard` directly in DashboardLayout (no header/title at page level)
2. On mount, loads departments for filter dropdown
3. Filters: Budget Year (5-year range), Start Date, End Date, Department, Variance Threshold (All / >5% / >10% / >25%)
4. "Generate Analysis" button queries approved budgets for selected year, then iterates through each budget line item
5. For each line item and each month in the date range, queries account_transactions individually (N+1 query pattern)
6. Monthly budget amounts read from individual month columns (jan_amount through dec_amount) on budget_line_items
7. Actual amounts calculated differently for revenue vs non-revenue: revenue = credit - debit, other = debit - credit, then Math.abs()
8. Variance = actual - budget; variance percent = (variance / budget) * 100
9. Results displayed in two views: "Summary View" (table) and "Monthly Trends" (card per account with monthly breakdown)
10. Summary table shows: Account, Department, Budget, Actual, Variance, Variance %, Status badge (On Track / Favorable / Unfavorable)
11. Monthly Trends view has "Drill Down" button per month per account that opens a dialog with actual journal entry transactions
12. Drill-down dialog shows: Budget Amount, Actual Amount, Variance cards + transaction table (Date, JE Number, Description, Reference, Debit, Credit)
13. Summary cards at top show: Revenue Variance, Expense Variance, Net Income Variance
14. Favorable/unfavorable logic: for revenue, positive variance = favorable; for expenses, negative variance = favorable
15. "On Track" badge for variances within +/- 5%
16. Direct Supabase queries in component (no custom hook) - all data fetching is inline

### Scaffolding Flags
- N+1 query pattern: one Supabase query per account per month (could be hundreds of queries for a year with many accounts)
- All data fetching logic is directly in the component, not abstracted into a hook
- Math.abs() applied to actual amounts (line 228) may mask negative actuals
- No export/download functionality
- None of the standard scaffolding patterns (TODO, Coming soon, empty handlers) found
