## ACC-026: Credit Management

**Route:** /accounting/credit-management
**Component:** src/pages/accounting/CreditManagement.tsx
**Guard:** Own auth check (useAuth + navigate to /login) + accounting.invoices.read (via ROUTE_PERMISSION_MAP['accounting'])

### Roles
- Full access (bypass): super_admin, owner, operations_manager
- Page-level auth: Checks `useAuth()` for user existence, redirects to /login if not authenticated
- This is the ONLY accounting page with its own auth redirect (all others rely solely on PermissionGuard)

### Database
- Credit Applications: `customer_credit_applications` (CRUD + review workflow)
- Customer Credit Terms: `customer_credit_terms` (upsert on approval)
- Credit Alerts: `credit_alerts` (filtered by business_id + is_active)
- Credit Monitoring: `ar_transactions` joined with `customer_credit_terms` (for credit utilization check)
- Customers: `customers` (for customer dropdowns and enrichment)
- Accounts Receivable: `ar_transactions` (for outstanding balance calculations)

### Behavior

#### Page Structure
1. Page does NOT use DashboardLayout — renders its own layout with header
2. Header shows "Credit Management" title with ShieldCheck icon
3. Three sub-tabs: "Credit Applications", "Customer Credit", "Credit Alerts"
4. Tab state managed via useState, defaults to "applications"

#### Tab 1: Credit Applications (CreditManagementPanel)
5. Fetches credit applications from `customer_credit_applications` filtered by business_id, ordered by created_at DESC
6. Customer enrichment: For each application, looks up customer by customer_id from customers list
7. "New Application" dialog with fields: Customer (select dropdown), Requested Amount, Business Type, Years in Business, Annual Revenue, Notes
8. Application has status workflow: pending → approved/denied/under_review
9. Review dialog shows application details and allows status change with review notes
10. On approval: Upserts `customer_credit_terms` with credit_limit = requested_amount, sets status='active'
11. On denial: Updates application status only, no credit terms created
12. Applications table shows: Customer, Amount Requested, Status (badge), Business Type, Applied Date, Actions
13. Status badge colors: approved=green, denied=red, under_review=yellow, pending=default

#### Tab 2: Customer Credit (CustomerCreditManagementTab)
14. Fetches customer credit terms from `customer_credit_terms` filtered by business_id
15. Fetches AR transactions for outstanding balance calculation
16. "Set Credit Terms" dialog with fields: Customer (select dropdown), Credit Limit, Payment Terms (days), Interest Rate (%), Credit Status (select)
17. Credit status options: active, suspended, revoked, pending_review
18. Creates or updates customer_credit_terms record
19. Credit terms table shows: Customer, Credit Limit, Available Credit, Payment Terms, Interest Rate, Status, Actions
20. Available credit = credit_limit - outstanding AR balance (calculated client-side)
21. "Edit" action re-opens dialog pre-filled with existing values
22. "Suspend" action updates status to 'suspended'
23. Customer name resolved by matching customer_id against customers list

#### Tab 3: Credit Alerts (CreditAlertsPanel)
24. Fetches credit alerts from `credit_alerts` filtered by business_id and is_active=true
25. "Run Credit Check" button: Queries ar_transactions and customer_credit_terms, checks if any customer's outstanding balance exceeds their credit limit
26. Credit check creates new credit_alert records for over-limit customers with alert_type='credit_limit_exceeded'
27. Alerts table shows: Customer, Alert Type (badge), Message, Severity (badge), Created Date, Actions
28. Alert type badge: credit_limit_exceeded=red, payment_overdue=yellow, credit_score_change=blue
29. Severity badge: high=red, medium=yellow, low=green
30. "Dismiss" button sets alert is_active=false (soft delete)
31. "Resolve" button also sets alert is_active=false
32. Alert message format: "Credit limit exceeded: Outstanding balance of $X exceeds credit limit of $Y"

### Scaffolding Flags
- Page has own useAuth() check + navigate('/login') — redundant with PermissionGuard but won't cause functional issues
- Credit check only detects `credit_limit_exceeded` — does not check payment_overdue or credit_score_change despite displaying badges for those alert types
- No automatic/scheduled credit monitoring — only manual "Run Credit Check" button
- Outstanding balance calculation depends on ar_transactions existing and being current
- No pagination on any of the three tables
- Customer dropdown depends on customers being loaded; no loading state shown in dialog
- Interest rate field stored but never used in any calculation
- Payment terms (days) stored but never used for overdue calculation
