## ACC-016: Bank Reconciliation

**Route:** /accounting/bank-reconciliation
**Component:** src/pages/accounting/BankReconciliationPage.tsx
**Guard:** accounting.invoices.read (via ROUTE_PERMISSION_MAP['accounting'])

### Roles
- Full access (bypass): super_admin, owner, operations_manager
- Navigation-level: FINANCIAL_ROLES (super_admin, owner, finance_manager, accountant, ar_specialist, ap_specialist), requiredPermissions: ['financial.banking.view']
- Route guard resolves to: DENIED for all non-FULL_ACCESS_ROLES (finance_manager, accountant, ar_specialist, ap_specialist see nav item but cannot access route)

### Database
- Primary: `bank_transactions` (via useBankReconciliation hook)
- Secondary: `bank_statements` (fetched in hook but not displayed directly)
- Service tables: `bank_accounts`, `bank_reconciliations`, `reconciliation_items`, `bank_statements` (via BankReconciliationService)
- Joins: None in primary query (select * from bank_transactions)
- Filters: `business_id = currentBusiness.id`, ordered by `transaction_date DESC`

### Behavior
1. Page is a thin wrapper rendering `BankReconciliationTab` inside `DashboardLayout`
2. On mount, fetches all `bank_transactions` and `bank_statements` for current business via `useBankReconciliation` hook
3. Displays 3 summary cards: Unmatched Transactions count, Matched Transactions count, Reconciliation Rate percentage
4. Has 4 sub-tabs: "Reconciliation Workflow", "Import Statements", "Match Transactions", "Reports & History"
5. "Reconciliation Workflow" tab renders `EnhancedBankReconciliationWorkflow` component
6. "Import Statements" tab shows file upload UI with bank account selector (from `useBankAccounts`) and date picker. Upload button calls `setShowFileUpload(true)` but does NOT actually process file uploads - there is no file input element or file handling logic
7. "Match Transactions" tab shows sortable table of transactions (limited to first 10 via `.slice(0, 10)`) with columns: Date, Description, Amount, Type, Status, Actions
8. Clicking "Match" button on unmatched transaction calls `BankReconciliationService.markTransactionAsReconciled()` which updates `is_reconciled = true` on the bank_transaction row (note: this uses `is_reconciled` field, but the hook/UI reads `is_matched` field - potential field name mismatch)
9. "Reports & History" tab shows reconciliation summary with bank balance, book balance, outstanding deposits, outstanding checks, and a hardcoded "Adjusted Bank Balance" of $24,890.25
10. "Generate Report" button calls `BankReconciliationService.generateReconciliationReport()` which opens results in a new browser window as raw HTML
11. Column preferences are persisted via `useColumnPreferences('bank-reconciliation', COLUMNS)` hook
12. Transaction details can be viewed in a `TransactionDetailsModal` with prev/next navigation
13. Bank balance is calculated client-side: credits - debits from all transactions
14. Book balance is calculated client-side: sum of matched transactions (credits positive, debits negative)

### Scaffolding Flags
- `handleFileUpload` sets state `setShowFileUpload(true)` but no actual file processing logic exists - the `showFileUpload` state is never consumed to render a file picker or process files
- `handleViewHistory` sets `setShowHistory(true)` but the `showHistory` state is never consumed to display anything
- Hardcoded adjusted bank balance: `$24,890.25` on line 514 of BankReconciliationTab.tsx
- TODO comment: `// TODO: Enhance with PDF generation or better formatting` (line 157)
- Potential field name mismatch: service uses `is_reconciled`, UI reads `is_matched`
